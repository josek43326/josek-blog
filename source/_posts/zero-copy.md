---
title: Zero Copy
---

### 零拷贝简介

**零拷贝**是指将数据直接从磁盘文件复制到网卡设备中，而不需要经由应用程序。零拷贝大大提高了应用程序的性能，减少了内核和用户模式之间的上下文切换。对 Linux 操作系统而言，零拷贝技术依赖于底层的 `sendfile()` 方法。在 Java 中，`FileChannal.transferTo()` 方法的底层实现就是 `sendfile()` 方法

### 未使用零拷贝

复制操作需要在用户模式和内核模式之间进行四次上下文切换，并且在操作完成之前将数据复制了四次

![传统数据复制方法](../img/%25E4%25BC%25A0%25E7%25BB%259F%25E6%2595%25B0%25E6%258D%25AE%25E5%25A4%258D%25E5%2588%25B6%25E6%2596%25B9%25E6%25B3%2595.drawio.svg)

1、调用 read() 时，用户态切换到内核态，DMA读取文件内容将其复制到内核模式下的 Read Buffer 中

2、CPU 控制将内核模式数据复制到用户模式下，read() 调用返回，内核态切换到用户态

3、调用 write() 时，用户态切换到内核态，将用户模式下的内容复制到内核模式下的 Socket Buffer 中

4、将 Socket Buffer 的数据通过DMA复制到网卡设备中传送，write() 调用返回，内核态切换到用户态

### 使用零拷贝

应用程序可以直接请求内核把磁盘中的数据传输给 Socket

#### **早期Linux未使用 gather operations 的零拷贝**

上下文切换2次，数据复制为3次

![零拷贝](../img/%25E9%259B%25B6%25E6%258B%25B7%25E8%25B4%259D.drawio.svg)

1、`transferTo()` 方法使得文件内容被 DMA 复制到读取缓冲区中

2、数据被内核复制到与输出套接字关联的 Socket Buffer 中

3、DMA 将数据从内核套接字缓冲区传递到协议引擎（网卡设备等）

#### **采用 gather operations 的改进后的零拷贝**

上下文切换2次，数据复制为2次

![改进版零拷贝](../img/%25E6%2594%25B9%25E8%25BF%259B%25E7%2589%2588%25E9%259B%25B6%25E6%258B%25B7%25E8%25B4%259D.drawio.svg)

1、`transferTo()` 方法使得文件内容被 DMA 复制到读取缓冲区中

2、改进后没有文件数据被复制到 Socket Buffer 中，只有包含有关**数据的位置**和**长度信息的描述符**才会附加到Socket Buffer， DMA 将数据直接从内核缓冲区传递到协议引擎（网卡设备等）
